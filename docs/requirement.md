# 要件定義書：まとめ

## プロジェクト概要

### プロジェクト名
SFプロトタイピング教育プラットフォーム

### 目的
教育用途における「自分探し×SFプロトタイピング×集団の意見の可視化」を実現するWebプラットフォーム。生徒が未来社会のテーマについて深く思考し、個人の回答を集団の意見マップとして可視化することで、対立点と合意点を明確にする。

### 基本コンセプト
- **没入感のある世界観**：ALTER EGOや伊藤計劃のハーモニーを参考にしたダークで重厚感のある雰囲気
- **モノクロ・ミニマルデザイン**：マットな質感、光沢や輝きを完全に排除
- **段階的な深掘り**：Big Five診断 → テーマ選択 → 質問回答 → 可視化
- **集団との対話**：個人の回答が集団の意見マップに反映される

---

## ユーザーロール

### 1. 管理者（Admin/Teacher）
- **セッション管理**：セッションの作成・管理（一セッション対応）
- **リアルタイム監視**：学生の進捗状況をリアルタイムで確認（SSE）
- **学生管理**：学生の回答状況、参加状況を詳細に管理・分析
- **結果分析**：意見マッピングの結果を詳細に分析（6段階の階層構造）

### 2. 生徒（Student）
- **インスタントビッグファイブ診断**：10問のショートビッグファイブテスト
- **テーマ選択**：4〜5つのテーマから興味のあるものを選択
- **テーマ概要確認**：メインページで関連SF作品や研究を確認
- **グループ活動**：斬新・面白いと感じたことを選択・共有
- **個人質問回答**：20個の質問に回答（はい/わからない/いいえの3択、逆三角形配置）
- **意見マッピング確認**：UMAPベースの可視化結果を確認

---

## 主要機能

### 1. インスタントビッグファイブ診断
- **質問数**：10問
- **回答方式**：0（まったくあてはまらない）〜4（完全にあてはまる）の5段階
- **スコア計算**：質問6-10の点数を反転後、各特性（外向性、協調性、誠実性、神経症傾向、開放性）を計算
- **結果表示**：レーダーチャートで5つの特性を可視化

### 2. 質問回答機能
- **質問数**：20問
- **回答方式**：はい/わからない/いいえの3択
- **UI設計**：逆三角形配置（わからないを中央上部、はい・いいえを下部左右）
- **色とアイコン**：色 + アイコン + テキストラベルで区別（アクセシビリティ対応）

### 3. 意見マッピング（UMAP可視化）
- **次元削減**：25次元ベクトル（20問の回答 + 5つのBig Fiveスコア）を2次元に削減
- **クラスタリング**：K-meansで意見グループを識別
- **対立・合意領域の検出**：クラスタ間距離とクラスタ内密度から検出
- **可視化**：2D散布図で学生の意見をマッピング
- **解釈上の注意表示**：可視化画面に「本結果は統計的傾向であり、個人評価を目的としない」注記を常時表示

### 4. 情報の階層整理（管理者向け）
- **レベル1**：全体サマリー（常に表示）
- **レベル2**：クラスタ分析結果（展開可能）
- **レベル3**：質問ごとの解答分布（展開可能、フィルター機能付き）
- **レベル4**：対立領域の詳細分析（展開可能）
- **レベル5**：合意領域の詳細分析（展開可能）
- **レベル6**：性格特性の分布（展開可能）

---

## 技術スタック

### フロントエンド
- **フレームワーク**：Next.js 14+ (App Router)
- **言語**：TypeScript
- **スタイリング**：Tailwind CSS（カスタムテーマ）
- **状態管理**：Zustand
- **可視化**：D3.js または Observable Plot
- **計算エンジン**：WebAssembly（Rust実装、UMAP、クラスタリング）

### バックエンド
- **フレームワーク**：Next.js API Routes
- **データベース**：PostgreSQL（Prisma ORM）
- **リアルタイム通信**：Server-Sent Events (SSE)
- **認証**：簡易認証（セッションID + パスコード、JWTトークン）

### デプロイメント
- **プラットフォーム**：Vercel（推奨）
- **CI/CD**：GitHub Actions
- **モニタリング**：Sentry、Vercel Analytics

---

## デザインシステム

### カラーパレット

**生徒側（モノクロベース）：**
- 背景色：`#000000`, `#1a1a1a`, `#2d2d2d`, `#404040`
- テキスト色：`#ffffff`, `#e0e0e0`, `#b0b0b0`, `#808080`
- アクセント色（限定的使用）：`#c62828`（赤）、`#1976d2`（青）、`#616161`（グレー）

**管理者側（高コントラスト）：**
- 背景色：`#ffffff`, `#f5f5f5`, `#e0e0e0`
- テキスト色：`#000000`, `#424242`, `#757575`
- セマンティックカラー：`#d32f2f`（エラー）、`#388e3c`（成功）、`#f57c00`（警告）、`#1976d2`（情報）

### タイポグラフィ

**フォントファミリー：**
- 見出し：`'Noto Serif JP'` または `'游明朝'`（セリフ体）
- 本文：`'Noto Sans JP'` または `'游ゴシック'`（サンセリフ体）

**タイポグラフィスケール：**
- H1: 48px / 1.2 / 700
- H2: 36px / 1.3 / 700
- H3: 28px / 1.4 / 600
- Body: 18px / 1.7 / 400
- Caption: 14px / 1.5 / 400

### スペーシングシステム
- 8pxベース：4px, 8px, 16px, 24px, 32px, 48px, 64px, 96px

### アニメーション
- **Duration**：fast（150ms）、normal（300ms）、slow（500ms）
- **Easing**：ease-in-out、ease-out、ease-in
- **パフォーマンス最適化**：`will-change`、GPU加速

---

## アクセシビリティ

### WCAG 2.1準拠
- **レベル**：AA準拠（推奨：AAA準拠）
- **コントラスト比**：通常テキスト4.5:1以上、大きなテキスト3:1以上

### キーボードナビゲーション
- Tab順序：論理的な順序
- ショートカットキー：Enter、Esc、Tab、Arrow Keys
- フォーカス管理：フォーカスインジケーター、フォーカストラップ

### スクリーンリーダー対応
- ARIA属性：aria-label、aria-labelledby、aria-describedby、aria-live等
- セマンティックHTML：button、nav、main、article、section

### 色だけに依存しない情報伝達
- 質問回答画面：色 + アイコン + テキストラベル
- チャート・グラフ：色 + パターン + 形状

---

## レスポンシブデザイン

### ブレークポイント
- **Mobile**：320px - 767px（1カラム）
- **Tablet**：768px - 1279px（2カラム）
- **Desktop**：1280px以上（3カラム）

### タッチ操作
- スワイプ操作：質問回答画面、意見マッピング画面
- ピンチズーム：意見マッピング画面
- タッチターゲット：最小44px × 44px

---

## データモデル

### 主要エンティティ
- **Session**：セッション情報
- **Theme**：テーマ情報
- **Question**：質問（20問）
- **BigFiveResult**：ビッグファイブ診断結果
- **StudentResponse**：学生回答
- **OpinionMapping**：意見マッピング（UMAP座標、クラスタ情報）
- **Student**：学生情報
- **Teacher**：教員情報
- **School**：学校情報（マルチテナント対応、Future Work）

### テナント戦略（現時点の方針）
- **今期の運用前提**：単一学校・単一テナント運用
- **将来拡張方針**：後方互換性を確保するため、主要テーブルに`tenant_id`追加可能な設計を維持

---

## セキュリティ

### 認証システム
- **管理者**：セッションID（UUID v4）+ パスコード（bcryptハッシュ化）+ JWTトークン
- **学生**：セッションIDのみ（匿名参加）

### 認証・認可の運用要件
- **ログイン失敗制御**：管理者ログインは5回失敗で15分ロックアウト
- **JWT有効期限**：アクセストークン15分、リフレッシュトークン8時間
- **セッション失効**：管理者による強制ログアウト機能を提供
- **監査ログ**：管理者の閲覧・エクスポート・設定変更を記録（だれが、いつ、何をしたか）

### データ保護
- 回答データのバリデーション（サーバー側）
- データの整合性確保（タイムスタンプ、重複防止）
- CSRF対策、XSS対策

### 教育データガバナンス
- **データ分類**：個人情報 / 準個人情報 / 統計情報
- **学生回答の扱い**：準個人情報として扱う
- **保持期間**：学生回答はセッション終了後90日、監査ログは180日、バックアップは30日
- **削除方針**：保持期間経過後に自動削除（法令・自治体規定により延長可能）
- **説明責任**：同意取得フロー、保護者・学校向け説明文、監査証跡を整備

---

## パフォーマンス要件

### 目標値
- **初回ロード時間**：< 2秒（静的コンテンツ）
- **回答保存時間**：< 500ms
- **UMAP計算時間**：< 5秒（50人の学生、20問）
- **リアルタイム更新遅延**：< 1秒

### 測定条件
- **計測端末**：学校配布Chromebook相当（Intel i3相当 / 8GB RAM以上）
- **ネットワーク前提**：校内Wi-Fi、同時接続50/100/150クライアント
- **統計指標**：P50 / P95 / P99で計測し、受け入れ判定はP95を使用
- **SLO**：50人・100人・150人でそれぞれ計測結果を記録

### 最適化手法
- **クライアントサイド処理優先**：UMAP計算をWASMでクライアント側で実行
- **SSG/ISR**：静的生成、インクリメンタル静的再生成
- **キャッシング**：IndexedDB（計算結果）、SWR/React Query（データ取得）

---

## 実装フェーズ

### Phase 1: 基盤構築
- プロジェクトセットアップ
- データベーススキーマ設計・実装（一セッション対応）
- 簡易認証システム
- 基本的なUIコンポーネント（モノクロ・マットデザイン）

### Phase 2: コア機能
- セッション管理（管理者向け）
- インスタントビッグファイブ診断
- 質問回答機能
- 情報の階層整理機能

### Phase 3: 可視化・分析
- UMAPベースの意見マッピング実装
- 対立・合意領域の検出アルゴリズム
- 性格特性によるグループ化
- 可視化UI

### Phase 4: リアルタイム機能
- 管理者ダッシュボード
- リアルタイム進捗監視（一セッション対応）
- SSE実装
- SSE切断時の再接続・再開制御実装（`Last-Event-ID`対応）

### Phase 5: 最適化・改善
- パフォーマンス最適化
- UI/UXの改善
- エラーハンドリング強化

---

## エラーハンドリング

### クライアント側
- **ネットワークエラー**：自動リトライ（指数バックオフ）、オフライン対応
- **バリデーションエラー**：リアルタイムバリデーション、エラーメッセージ表示
- **認証エラー**：自動ログアウト、ログイン画面へリダイレクト
- **クライアント側エラー**：React Error Boundary、Sentryに送信
- **SSE切断**：再接続中バナー表示、最大再試行回数超過時に手動再接続UIを表示

### サーバー側
- **エラーログ**：構造化ログ（JSON形式）
- **エラーレスポンス**：JSON形式、適切なHTTPステータスコード
- **APIレスポンス仕様**：主要APIの正常系/異常系/認証失敗をOpenAPIまたはJSON Schemaで定義
- **SSE復旧戦略**：イベントIDを保持し、再接続時に欠落イベントを再送

---

## ログ・モニタリング

### ログ戦略
- **サーバー側**：Winston（Node.js）、構造化ログ
- **クライアント側**：Sentry、LogRocket

### モニタリング
- **パフォーマンス**：Vercel Analytics、New Relic、Datadog
- **エラー追跡**：Sentry
- **ユーザー行動分析**：Google Analytics（匿名化）、Plausible Analytics

---

## テスト戦略

### 受け入れ基準（リリースゲート）
- 主要APIの正常系/異常系/認証失敗のレスポンス仕様が文書化されている
- 可視化画面に「解釈上の注意」注記が表示されている
- 50/100/150人条件で性能計測を実施し、P95が目標値以内である
- 障害時Runbook（問い合わせ窓口、ログ採取、一次切り分け）が整備されている

### 単体テスト
- **対象**：ビジネスロジック、ユーティリティ関数、Reactコンポーネント
- **ツール**：Jest、React Testing Library
- **カバレッジ目標**：80%以上

### 統合テスト
- **対象**：APIエンドポイント、データベース操作、SSE接続
- **ツール**：Jest + Supertest

### E2Eテスト
- **対象**：主要なユーザーフロー
- **ツール**：Playwright または Cypress

---

## デプロイメント

### デプロイ環境
- **推奨プラットフォーム**：Vercel（Next.jsに最適化）
- **環境構成**：開発環境、ステージング環境、本番環境

### CI/CDパイプライン
- **GitHub Actions**：
  - プルリクエスト時：リント、型チェック、単体テスト、ビルドテスト
  - マージ時：統合テスト、ステージング環境へデプロイ
  - 本番リリース時：E2Eテスト、本番環境へデプロイ

### データバックアップ
- **頻度**：1日1回（自動）、重要なセッション終了後（手動）
- **保存期間**：30日間
- **保存先**：クラウドストレージ（AWS S3、Google Cloud Storage）

---

## 今後の議論ポイント

1. **次元削減アプローチの最終決定**：全次元UMAP vs 分離UMAP vs 階層的削減
2. **UMAPパラメータの調整方法**：固定値 vs 動的調整
3. **対立・合意の閾値設定**：クラスタ間距離、クラスタ内密度の閾値
4. **WASM実装の優先度**：初期実装はJavaScriptでプロトタイプ → WASM化
5. **データ永続化戦略**：UMAP計算結果をサーバー側に保存するか
6. **リアルタイム更新の頻度**：5秒ごと（調整可能）
7. **大規模データ対応**：100人以上の学生が参加した場合の処理方法

---

## 関連ドキュメント

- **詳細な要件定義書**：`docs/references/要件定義書作成_1b6be8b9.plan.md`（移設予定）
- **エンジニア評価レポート**：`docs/references/要件定義書_エンジニア評価.md`（移設予定）
- **デザイナーレビューレポート**：`docs/references/要件定義書_デザイナーレビュー.md`（移設予定）

---

## 更新履歴

- **2024年**：要件定義書作成、エンジニア評価、デザイナーレビュー、改善反映
