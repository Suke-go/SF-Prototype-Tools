# `docs/requirement.md` セキュリティレビュー

対象ドキュメントの要件を、教育プラットフォームとしての実運用を想定してレビューしました。

## 総評

- 現状の要件は「機能要件」は十分に整理されていますが、**脅威モデル・認可設計・個人情報保護・運用時統制**の記述が不足しています。
- 特に「学生はセッションIDのみで参加」は運用次第で成立しますが、**なりすまし・荒らし・不正回答注入**に対して脆弱です。
- 「CSRF/XSS対策」といった単語はありますが、実装レベルの要件（Cookie属性、CSP、トークンの保存方式、レート制限など）に分解されていないため、実装時に抜け漏れリスクがあります。

## 重大度つき指摘

## 1. 認証・認可モデルが弱い（重大度: 高）

### 指摘
- 管理者は「セッションID + パスコード + JWT」、学生は「セッションIDのみ」と記載されています。
- 学生参加に本人性確認が無く、セッションID流出時の不正参加を防ぐ要件が不足しています。

### リスク
- 第三者がセッションに参加し、回答汚染・授業妨害を行う可能性。
- 同一人物による多重回答（Sybil的行為）で集団可視化が歪む可能性。

### 推奨要件
- 学生参加に「使い捨て参加コード（短寿命）」「教員発行ワンタイムトークン」「学籍番号連携（必要時）」のいずれかを導入。
- 参加トークンに有効期限、再利用不可（ワンタイム）制約を追加。
- 1デバイス/1トークン制御、異常な多重参加の検知ルールを定義。

## 2. JWT運用要件が不十分（重大度: 高）

### 指摘
- JWT利用が示される一方で、鍵管理・有効期限・失効戦略が未定義です。

### リスク
- 長寿命トークン漏洩時の不正利用継続。
- 署名鍵ローテーション不備によるインシデント長期化。

### 推奨要件
- JWTは短寿命（例: 15分）+ リフレッシュトークン（ローテーション）を要件化。
- 鍵ローテーション周期（例: 90日）・緊急失効手順を定義。
- トークン保管は`HttpOnly` + `Secure` + `SameSite` Cookieを原則化。

## 3. CSRF/XSS対策が抽象的（重大度: 高）

### 指摘
- 「CSRF対策、XSS対策」の記載のみで具体要件が不足。

### リスク
- 実装者依存で対策強度がばらつく。
- 可視化画面/自由記述導入時にStored XSSが混入する可能性。

### 推奨要件
- CSP（`default-src 'self'`ベース）を導入し、`script-src`をnonce/hash方式に固定。
- サーバー/クライアント双方で入力サニタイズ・出力エスケープ要件を明記。
- CSRFトークン（二重送信またはSynchronizer Token）を状態変更APIに必須化。

## 4. レート制限・BOT対策の不足（重大度: 中〜高）

### 指摘
- API・認証・回答投稿・SSE接続に対するレート制限要件なし。

### リスク
- 総当たり（パスコード探索）、DoS、回答スパム、SSE接続枯渇。

### 推奨要件
- IP/ユーザー/セッション単位のレート制限をAPI別に定義。
- 管理者ログインは段階的遅延・アカウントロック・監査通知を追加。
- WAF/CDNレイヤーで異常トラフィック遮断要件を追記。

## 5. 個人情報・教育データの保護要件が不足（重大度: 高）

### 指摘
- Big Fiveや回答データはセンシティブ性が高いが、暗号化・保持・利用制限の具体化が不足。

### リスク
- 生徒プロファイルの不要な再識別、不適切な二次利用、漏洩時影響拡大。

### 推奨要件
- 保存時暗号化（DB暗号化 + 列レベル暗号化の検討）を明文化。
- データ最小化（目的外属性を収集しない）・保持期限（例: 学期終了後○日で削除）を定義。
- 匿名化/仮名化ポリシー、エクスポート時マスキング要件を追加。

## 6. 監査ログ要件が弱い（重大度: 中）

### 指摘
- 「構造化ログ」はあるが、誰が何をしたかの監査要件が不足。

### リスク
- 事後追跡不可、内部不正・設定ミス・誤操作の原因究明困難。

### 推奨要件
- 監査ログ対象（ログイン、設定変更、データ閲覧/出力、権限変更）を明示。
- 改ざん耐性（Write Once保管、署名/ハッシュチェーン）と保持期間を規定。
- 監査ログ閲覧権限を最小化し、アクセス自体も記録。

## 7. SSE運用のセキュリティ要件不足（重大度: 中）

### 指摘
- リアルタイム監視でSSEを使うが、接続認可・再接続時認証・情報露出制御が未定義。

### リスク
- 別クラス・別セッション情報の漏洩、再接続連打によるリソース圧迫。

### 推奨要件
- SSEエンドポイントをセッション境界で厳密認可。
- 再接続トークン検証、接続数上限、アイドルタイムアウトを要件化。
- イベントペイロードの最小化（PII排除）を明記。

## 8. サプライチェーン/CI-CDセキュリティが未定義（重大度: 中）

### 指摘
- CI/CD手順はあるが、依存関係スキャン・秘密情報管理・署名検証が不足。

### リスク
- 悪性依存パッケージ混入、シークレット漏洩、改ざん成果物の配布。

### 推奨要件
- Dependabot/Renovate + SCA（`npm audit`, Snyk等）を必須化。
- GitHub ActionsのOIDC連携、長期鍵の廃止、環境保護ルールを導入。
- SBOM生成と重大脆弱性ゲート（CVSS閾値）を追加。

## 9. セキュリティテスト要件が不足（重大度: 中）

### 指摘
- 現行のテスト戦略は機能中心で、セキュリティ検証が不足。

### 推奨要件
- SAST、DAST、依存脆弱性スキャンをCI必須ジョブ化。
- 主要脅威（認可回避、IDOR、CSRF、XSS、レート制限回避）の回帰テストを定義。
- リリース前にOWASP ASVS L2相当のチェックリストを適用。

## 10. インシデント対応・鍵管理が未定義（重大度: 中）

### 指摘
- モニタリング要件はあるが、インシデント時の初動や鍵ローテーション手順が不足。

### 推奨要件
- インシデント対応手順（検知→封じ込め→根絶→復旧→再発防止）を定義。
- 連絡体制（学校・保護者・運営）と通知基準を明文化。
- シークレット管理（KMS/Vault）と定期ローテーション方針を追加。

## 追加すべき最小セキュリティ要件（提案）

1. 脅威モデリング（STRIDE）をPhase 1で実施。
2. 認可マトリクス（Admin/Student/Session境界）を仕様化。
3. APIセキュリティ標準（入力検証、出力エスケープ、レート制限、監査ログ）を全エンドポイントに適用。
4. 個人情報保護方針（取得目的、保持期間、削除、第三者提供）を文書化。
5. セキュリティ受け入れ基準（ASVS準拠項目）をリリースゲートに設定。

## 優先対応ロードマップ

- **即時（今週）**
  - 学生参加方式の強化（ワンタイム参加コード）
  - 管理者認証の強化（短寿命JWT + Cookie属性固定）
  - レート制限導入（ログイン/回答/API）
- **短期（1〜2スプリント）**
  - CSP、CSRFトークン、監査ログ拡張
  - 機密データ保持・削除ポリシー策定
  - CIにSAST/SCA導入
- **中期（四半期）**
  - DAST・ペンテスト実施
  - 鍵管理とインシデント演習の運用定着
