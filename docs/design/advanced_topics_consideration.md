# 高度設計トピック考察（グループ活動UI/分析/計算基盤/運用品質）

## 0. 目的と前提

本書は、以下6テーマの実装方針を「段階導入できる設計」として整理する。

1. グループ活動画面（`GroupActivity`中心のUI/UX）
2. 教師向け詳細分析UI（6レベル階層）
3. Rust+WASMによるUMAP/クラスタリング置き換え
4. IndexedDB＋SWR/React Queryを使ったクライアントキャッシュ
5. アクセシビリティ（ARIA/キーボードショートカット）
6. テスト・ログ・モニタリング・CI/CD・バックアップ

---

## 1. グループ活動画面（GroupActivity UI/UX）

### 1.1 画面責務の分離

`GroupActivity`は「授業進行のハブ画面」とし、以下を明確に分離する。

- **進行状態**: 今どのフェーズか（導入/個人思考/共有/振り返り）
- **参加状態**: 誰が完了・未完了か
- **成果物状態**: 投稿・分類・投票結果

提案構成:

- `GroupActivityShell`: レイアウトとページ遷移
- `PhaseTimeline`: フェーズ進行（現在地・残時間）
- `ParticipantProgressPanel`: 参加者進捗
- `ArtifactBoard`: 付箋・発言・クラスタ表示
- `TeacherControlDock`: 教師操作（次フェーズ、再開、締切）

### 1.2 UX設計原則

- **常時可視化**: 「次に何をすべきか」を1画面で理解可能にする
- **誤操作防止**: 破壊的操作（全リセット等）に2段階確認
- **状態復元**: リロード時に同じフェーズへ復帰
- **帯域劣化対応**: 接続不安定時は遅延表示・再送キューを明示

### 1.3 リアルタイム更新

- 配信チャネルはSSEを第一候補、双方向性が必須ならWebSocketへ拡張
- イベント種別を固定（`phase_changed`, `artifact_added`, `vote_updated` 等）
- 楽観更新とサーバー確定イベントを分離し、整合性崩れを検知

---

## 2. 教師向け詳細分析UI（6レベル階層）

### 2.1 推奨6レベル情報設計

深掘り順に情報密度を上げる。

1. **クラス全体サマリ**（参加率、発言量、対立/合意率）
2. **グループ比較**（班ごとの差分、偏り）
3. **トピック/論点レベル**（議題別の賛否分布）
4. **対立/合意構造**（クラスタ間距離、橋渡し意見）
5. **個人行動特性**（発話傾向、影響度、応答時間）
6. **性格特性分布**（Big Five等との相関可視化）

### 2.2 UIパターン

- 左ペイン: 階層ナビゲーション（レベル1〜6）
- 中央: 主可視化（散布図、ネットワーク図、ヒートマップ）
- 右ペイン: 根拠データ（発言抜粋、時系列、メタデータ）

### 2.3 分析の説明責任（Explainability）

- 各分析カードに「計算方法」「入力データ範囲」「信頼度」を表示
- 「この結論は仮説である」ラベルを明示（過剰解釈防止）
- 個人特性は匿名化閾値（例: n<5非表示）を適用

---

## 3. Rust + WASMでのUMAP/クラスタリング置き換え

### 3.1 置き換えの狙い

- 大規模回答データでの計算時間短縮
- ブラウザ内処理によるサーバーコスト削減
- 再現性ある計算（seed固定）

### 3.2 アーキテクチャ

- `wasm/embedding`（Rust）: 前処理 + UMAP
- `wasm/clustering`（Rust）: HDBSCAN / k-means
- `lib/visualization/*.worker.ts`: Worker経由で非同期実行
- JS側は「入力検証」「キャンセル制御」「進捗表示」を担当

### 3.3 実装要点

- **シリアライズ最適化**: JSONではなく`Float32Array`で受け渡し
- **メモリ管理**: 大規模データはchunk処理でOOM回避
- **フォールバック**: WASM失敗時はJS実装へ切替
- **互換性試験**: JS版との座標誤差許容（例: ε<1e-3）を定義

### 3.4 段階導入

1. まずクラスタリングのみWASM化
2. 次にUMAPをWASM化
3. 最後に前処理（距離計算等）をWASM化

---

## 4. IndexedDB + SWR/React Query キャッシュ戦略

### 4.1 二層キャッシュ

- **メモリ層**: SWR/React Query（即時表示）
- **永続層**: IndexedDB（オフライン復元）

推奨は React Query + `persistQueryClient` + IndexedDB persister。

### 4.2 キャッシュキー設計

キーは最低限以下を含む。

- `sessionId`
- `phaseId`
- `role`（teacher/student）
- `analysisVersion`（分析ロジック更新検知）

### 4.3 無効化ルール

- フェーズ遷移時: 進行系クエリを無効化
- 分析アルゴリズム更新時: `analysisVersion`変更で一括再計算
- 長期放置時: TTL超過でバックグラウンド再フェッチ

### 4.4 オフライン時UX

- 明示的な「オフラインモード」バッジ
- 送信失敗データをOutboxに積み、復帰時に自動再送
- 競合時は「最新優先/手動マージ」を教師に選択可能にする

---

## 5. アクセシビリティ（ARIA/ショートカット）

### 5.1 ARIA実装の重点

- フェーズ変更は`aria-live="polite"`で通知
- グラフ要素に代替テキスト（要約 + 重要差分）
- キーボードで全操作可能（タブ順序・フォーカスリング可視化）

### 5.2 ショートカット設計

- `?` : ショートカット一覧
- `N/P` : 次/前フェーズ
- `G` : グループ一覧へフォーカス
- `A` : 分析パネルへフォーカス
- `Esc` : モーダル閉じる

※ 既存ブラウザショートカットと衝突しない組合せを優先。

### 5.3 運用指標

- 主要導線のキーボード操作成功率
- スクリーンリーダー読み上げ確認（NVDA/VoiceOver）
- WCAG 2.1 AAを最低ラインとして継続監査

---

## 6. 運用品質（テスト/ログ/監視/CI/CD/バックアップ）

### 6.1 テスト戦略

- Unit: 計算ロジック、バリデーション
- Integration: API + DB + cache整合性
- E2E: 授業進行シナリオ（教師/生徒ロール）
- Visual Regression: 主要分析画面（崩れ検知）

### 6.2 ログと監視

- 構造化ログ（`sessionId`, `phaseId`, `requestId`を必須）
- フロント監視: Sentry（JS例外、WASM失敗率）
- バックエンド監視: API latency, error rate, SSE切断率
- 事業KPI: 授業完了率、再接続成功率、分析閲覧率

### 6.3 CI/CDのゲート

- PRで必須: lint, typecheck, unit, integration（一部）
- main反映前: e2e smoke
- デプロイ後: synthetic monitoring + 自動ロールバック条件

### 6.4 バックアップ/復旧

- DB: 日次フル + 5分差分（可能ならPITR）
- 復旧演習: 月1回、RTO/RPOを計測
- 事故対応Runbook: 障害検知→切り分け→告知テンプレまで整備

---

## 7. 推奨ロードマップ（実装順）

1. `GroupActivity` の画面責務分離 + React Query導入
2. 教師分析UIをレベル1〜3まで先行リリース
3. WASMクラスタリング先行導入（フォールバック付き）
4. レベル4〜6分析 + アクセシビリティ改善
5. 監視・運用品質の自動化を本番SLOに接続

この順に進めると、学習体験への即効性（UI改善）と技術負債抑制（基盤整備）を両立しやすい。
